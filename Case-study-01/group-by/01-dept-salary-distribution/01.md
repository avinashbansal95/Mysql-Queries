Problem 1: Department Salary Distribution
For each department, calculate:

Total salary
Average salary
Number of employees
Number of managers (i.e., employees who are someone’s manager)
Ratio of managers to total employees (as decimal)
Show: dept_name, total_salary, avg_salary, emp_count, manager_count, manager_ratio


# Manager Ratio Analysis by Department

## Step-by-Step Explanation

### 1. Base Table: Departments

```sql
FROM departments d
```

* Starts from the `departments` table so that even departments with **no employees** are included in the result.
* This ensures we see all departments in the output.

### 2. Counting Managers per Department (Subquery `x`)

```sql
SELECT 
    e.dept_id, 
    COUNT(DISTINCT e.emp_id) AS manager_count 
FROM employees e 
JOIN employees e1 ON e.emp_id = e1.manager_id 
GROUP BY e.dept_id
```

* `JOIN employees e1 ON e.emp_id = e1.manager_id` finds employees who manage at least one other person.
* `COUNT(DISTINCT e.emp_id)` ensures each manager is counted once per department.
* Grouped by `dept_id` to get per-department manager counts.
* Later joined with `departments` using `LEFT JOIN` so departments with no managers get a count of **0**.

### 3. Calculating Total, Average, and Count of Employees (Subquery `y`)

```sql
SELECT 
    dept_id, 
    SUM(salary) AS total_salary, 
    AVG(salary) AS avg_salary, 
    COUNT(emp_id) AS emp_count 
FROM employees 
GROUP BY dept_id
```

* Aggregates salaries and employee counts per department.
* `SUM(salary)` → total salaries.
* `AVG(salary)` → average salary (later rounded by DB or in output).
* `COUNT(emp_id)` → number of employees in the department.

### 4. Joining the Aggregates

```sql
LEFT JOIN x ON d.dept_id = x.dept_id
LEFT JOIN y ON d.dept_id = y.dept_id
```

* Joins both aggregate subqueries to the `departments` table.
* `LEFT JOIN` ensures all departments appear, even if they have no employees (`NULL` values are handled with `COALESCE`).

### 5. Calculating the Manager Ratio

```sql
COALESCE(
    CAST(x.manager_count AS DECIMAL(10,2)) / CAST(y.emp_count AS DECIMAL(10,2)), 
    0
) AS manager_ratio
```

* Divides the number of managers by total employees to get the ratio.
* Casts to `DECIMAL(10,2)` to ensure decimal precision.
* `COALESCE(..., 0)` handles divisions by `NULL` when there are no employees.

## Example Output

| dept_name | manager_count | total_salary | avg_salary | emp_count | manager_ratio |
|-----------|---------------|--------------|------------|-----------|---------------|
| Engineering | 2 | 269000.00 | 67250.00 | 4 | 0.50 |
| Sales | 1 | 188000.00 | 62666.67 | 3 | 0.33 |
| Marketing | 1 | 104000.00 | 52000.00 | 2 | 0.50 |
| HR | 0 | 58000.00 | 58000.00 | 1 | 0.00 |
| Finance | 0 | 53000.00 | 53000.00 | 1 | 0.00 |

## Key Points

* `LEFT JOIN` from `departments` ensures inclusion of departments with no employees.
* Two separate subqueries make the query cleaner and easier to maintain.
* `COALESCE` is used to replace `NULL` values with `0`.
* Explicit type casting prevents integer division errors.
* Manager count logic depends on `manager_id` being set correctly.